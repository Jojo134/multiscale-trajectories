<!DOCTYPE html>
<html>
<head>
<script src="papaparse.js"></script>
<!--<script src="jquery-3.2.1.min.js"></script>-->
<link href="style.css" rel="stylesheet"></link>
</head>
<body>
<div id="listContainer"></div>
<button onclick="decrease()">-</button>
<button onclick="increase()">+</button>
<button onclick="updateView()">Update View</button>
<div class="container">
  <div class="wrapper">
<canvas id="myCanvas" width="1000" height="1000">
Your browser does not support the HTML5 canvas tag.</canvas>
</div>
</div>
<script>
//maybe useful for interactivity https://gist.github.com/starcalibre/5dc0319ed4f92c4fd9f9
file= '/data/all_fixation_data_cleaned_up.csv';
Papa.parse(file, { download: true, header: true, complete: doneReading, error: errorLog });

var c = document.getElementById('myCanvas');
var ctx = c.getContext('2d');
ctx.moveTo(0,0);
ctx.lineTo(c.width,c.height);
ctx.stroke();
ctx.moveTo(0,0);
ctx.lineTo(c.width,0);
ctx.stroke();
ctx.moveTo(0,100);
ctx.lineTo(c.width,100);
ctx.stroke();

var sections = 1;
function increase(){
	sections++;
	ctx.clearRect(0,0,c.width,c.height);
	drawGrid();
	console.log(sections);
}
function decrease(){
	sections--;
	ctx.clearRect(0,0,c.width,c.height);
	drawGrid();
	console.log(sections);
}
function drawGrid(){
	var ySteps = Math.round(c.height/sections);
	var xSteps = Math.round(c.width/sections);
	ctx.beginPath();
	for (var i = 0; i< ySteps;i++){
		ctx.moveTo(0,i*ySteps);
		ctx.lineTo(c.width,i*ySteps);
		ctx.stroke();
	}
	for(var j=0;j< xSteps;j++){
		ctx.moveTo(j*xSteps,0);
		ctx.lineTo(j*xSteps,c.height);
		ctx.stroke();
	}
	ctx.closePath();
}
function doneReading(data) {
	var MaxMappedFixationPointX = Math.max(...Array.from(data.data, o=> o.MappedFixationPointX));
	var MaxMappedFixationPointY = Math.max(...Array.from(data.data, o=> o.MappedFixationPointY));
	var MinMappedFixationPointX = Math.min(...Array.from(data.data, o=> o.MappedFixationPointX));
	var MinMappedFixationPointY = Math.min(...Array.from(data.data, o=> o.MappedFixationPointY));
	var users = new Set(Array.from(data.data, o=> o.user));
	console.log(users);
	var StimuliName = new Set(Array.from(data.data, o=> o.StimuliName));
	console.log(StimuliName);
	document.getElementById('listContainer').appendChild(makeList('stimuli-list',[...StimuliName]));
	document.getElementById('listContainer').appendChild(makeList('user-list',[...users]));
	
	console.log('Max X',MaxMappedFixationPointX);
	console.log('Max Y',MaxMappedFixationPointY);
	
	console.log('Min X',MinMappedFixationPointX);
	console.log('Min Y',MinMappedFixationPointY);
	
	loadedData = data.data;
	console.log(data);
}

function errorLog(error){
	console.log(error);
}
function updateView(){
	ctx.clearRect(0,0,c.width,c.height);
	drawGrid();
	selected = document.querySelectorAll('#user-list option:checked');
	valuesUserList = Array.from(selected).map((el) => el.value);
	console.log(valuesUserList);
	selected = document.querySelectorAll('#stimuli-list option:checked');
	valuesStimuliList = Array.from(selected).map((el) => el.value);
	console.log(valuesStimuliList);
	filterData = loadedData.filter(o => valuesUserList.indexOf(o.user) !== -1)
						.filter(o => valuesStimuliList.indexOf(o.StimuliName) !== -1)
						//negative raus
						.filter(o => o.MappedFixationPointX >== 0 && o.MappedFixationPointY >== 0)
						//max raus
						.filter(o => o.MappedFixationPointX <== 1200 && o.MappedFixationPointY <== 1700);
	console.log(filterData);
	var maxX = Math.max(...Array.from(loadedData, o=> o.MappedFixationPointX));
	var maxY= Math.max(...Array.from(loadedData, o=> o.MappedFixationPointY));
	var minX = Math.min(...Array.from(loadedData, o=> o.MappedFixationPointX));
	var minY= Math.min(...Array.from(loadedData, o=> o.MappedFixationPointY));
	var rangeX = maxX - minX;
	var rangeY = maxY - minY;
	console.log("Values",maxX, minX, rangeX);
	//offscreenCanvas
	
	//ctx.scale()
	/*[
	user1:[]
	user2:[]
	]
	*/
	
	//draw
	filterData.forEach((d,idx,array) => {
		ctx.fillStyle = stringToColor.next(d.user);
		ctx.fillRect(d.MappedFixationPointX,d.MappedFixationPointY,5,5);
		ctx.font = "10px Arial";
		ctx.fillText(d.user,d.MappedFixationPointX,d.MappedFixationPointY);
		if(idx !== 0 && array[idx-1].user === d.user){
			drawLine(array[idx-1].MappedFixationPointX,array[idx-1].MappedFixationPointY,d.MappedFixationPointX,d.MappedFixationPointY)
		}
	});
}

function drawPath(cordArray){
	ctx.moveTo(cordArray[0].MappedFixationPointX, cordArray[0].MappedFixationPointY);
	for(point =  1; point < cordArray.length; point++){
		console.log(cordArray[point]);
		ctx.lineTo(cordArray[point].MappedFixationPointX, cordArray[point].MappedFixationPointY);
	}
	ctx.strokeStyle = ctx.fillStyle;
	ctx.stroke();
}

function drawLine(x1,y1,x2,y2){
	ctx.strokeStyle = ctx.fillStyle;
	ctx.moveTo(x1,y1);
	ctx.stroke();
}

var stringToColor = (function(){
    var instance = null;

    return {
    next: function stringToColor(str) {
        if(instance === null) {
            instance = {};
            instance.stringToColorHash = {};
            instance.nextVeryDifferntColorIdx = 0;
            instance.veryDifferentColors = ["#000000","#00FF00","#0000FF","#FF0000","#01FFFE","#FFA6FE","#FFDB66","#006401","#010067","#95003A","#007DB5","#FF00F6","#FFEEE8","#774D00","#90FB92","#0076FF","#D5FF00","#FF937E","#6A826C","#FF029D","#FE8900","#7A4782","#7E2DD2","#85A900","#FF0056","#A42400","#00AE7E","#683D3B","#BDC6FF","#263400","#BDD393","#00B917","#9E008E","#001544","#C28C9F","#FF74A3","#01D0FF","#004754","#E56FFE","#788231","#0E4CA1","#91D0CB","#BE9970","#968AE8","#BB8800","#43002C","#DEFF74","#00FFC6","#FFE502","#620E00","#008F9C","#98FF52","#7544B1","#B500FF","#00FF78","#FF6E41","#005F39","#6B6882","#5FAD4E","#A75740","#A5FFD2","#FFB167","#009BFF","#E85EBE"];
        }

        if(!instance.stringToColorHash[str])
            instance.stringToColorHash[str] = instance.veryDifferentColors[instance.nextVeryDifferntColorIdx++];

            return instance.stringToColorHash[str];
        }
    }
})();
function makeList(id, array) {
    var list = document.createElement('select');
	list.setAttribute('multiple','multiple');
	list.setAttribute('id', id);
    for(var i = 0; i < array.length; i++) {
        var item = document.createElement('option');
		item.appendChild(document.createTextNode(array[i]));
        list.appendChild(item);
    }
    return list;
}
</script>

</body>
</html>
